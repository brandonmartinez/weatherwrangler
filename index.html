<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wrangler Weather</title>
    <script>
      // Weather API configuration - using OpenWeatherMap API
      const WEATHER_API_KEY = "WEATHER_API_KEY_PLACEHOLDER"; // This will be replaced during build

      async function fetchWeather(lat, lon) {
        if (
          !WEATHER_API_KEY ||
          WEATHER_API_KEY === "WEATHER_API_KEY_PLACEHOLDER"
        ) {
          throw new Error(
            "Weather API key not configured. Please check your .env file or GitHub secrets."
          );
        }

        const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=imperial`;
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(
            `Failed to fetch weather: ${res.status} ${res.statusText}`
          );
        }
        return res.json();
      }

      function evaluateConditions(weather) {
        // OpenWeatherMap forecast data - analyze today's hourly data
        const now = new Date();
        const todayStart = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate()
        );
        const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);

        // Filter forecasts for today
        const todayForecasts = weather.list.filter((forecast) => {
          const forecastTime = new Date(forecast.dt * 1000);
          return forecastTime >= todayStart && forecastTime < todayEnd;
        });

        if (todayForecasts.length === 0) {
          // If no forecasts for today, use the first few available
          todayForecasts.push(...weather.list.slice(0, 8));
        }

        let maxTemp = -Infinity;
        let maxRainChance = 0;
        let maxWind = -Infinity;

        for (const forecast of todayForecasts) {
          maxTemp = Math.max(maxTemp, Math.round(forecast.main.temp));

          // Calculate rain chance from weather conditions
          let rainChance = 0;
          if (forecast.weather && forecast.weather[0]) {
            const weatherId = forecast.weather[0].id;
            // Rain: 500-531, Drizzle: 300-321, Thunderstorm: 200-232
            if (weatherId >= 200 && weatherId <= 531) {
              // Use probability of precipitation if available
              rainChance = forecast.pop ? forecast.pop * 100 : 50;
            }
          }
          maxRainChance = Math.max(maxRainChance, rainChance);

          // Convert m/s to mph
          maxWind = Math.max(maxWind, Math.round(forecast.wind.speed * 2.237));
        }

        const topOff = maxTemp >= 60 && maxRainChance < 10;
        const doorsOff = maxTemp >= 65 && maxRainChance < 10 && maxWind < 15;

        return {
          topOff,
          doorsOff,
          maxTemp,
          minRain: Math.round(maxRainChance),
          maxWind,
        };
      }

      function renderResult({ topOff, doorsOff, maxTemp, minRain, maxWind }) {
        document.getElementById("result").innerHTML = `
        <div class="font-semibold text-xl">Today's Wrangler Weather</div>
        <div class="mt-4">
          <p><strong>Max Temperature:</strong> ${maxTemp}Â°F</p>
          <p><strong>Rain Chance:</strong> ${minRain}%</p>
          <p><strong>Max Wind Speed:</strong> ${maxWind} MPH</p>
        </div>
        <div class="mt-6">
          <p class="font-bold text-green-600">Top Off: ${
            topOff ? "Yes" : "No"
          }</p>
          <p class="font-bold text-green-600">Doors Off: ${
            doorsOff ? "Yes" : "No"
          }</p>
        </div>
      `;
      }

      function showError(error) {
        document.getElementById(
          "result"
        ).textContent = `Error: ${error.message}`;
      }

      function getLocationAndFetchWeather() {
        if (!navigator.geolocation) {
          showError(new Error("Geolocation not supported"));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            try {
              const { latitude, longitude } = position.coords;
              const weather = await fetchWeather(latitude, longitude);
              const conditions = evaluateConditions(weather);
              renderResult(conditions);
            } catch (e) {
              showError(e);
            }
          },
          (err) => {
            showError(new Error("Failed to get location"));
          }
        );
      }

      window.onload = getLocationAndFetchWeather;
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 p-4 font-sans text-gray-900">
    <div
      class="bg-white shadow-md mx-auto mt-10 p-6 rounded-xl max-w-md overflow-hidden"
    >
      <h1 class="mb-4 font-bold text-2xl text-center">Wrangler Weather</h1>
      <div id="result" class="text-center">Loading...</div>
    </div>
  </body>
</html>
