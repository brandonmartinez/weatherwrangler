<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wrangler Weather</title>
    <link href="/index.css" rel="stylesheet" />
    <script>
      // Weather API configuration - using OpenWeatherMap API
      const WEATHER_API_KEY = "WEATHER_API_KEY_PLACEHOLDER"; // This will be replaced during build

      // Configurable weather thresholds for Jeep recommendations
      // Minimum temperature (°F) for top off recommendation
      const TEMP_THRESHOLD_TOP_OFF = 60;
      // Minimum temperature (°F) for doors off recommendation
      const TEMP_THRESHOLD_DOORS_OFF = 65;
      // Maximum rain chance (%) for any recommendation
      const RAIN_CHANCE_THRESHOLD = 10;
      // Maximum wind speed (mph) for doors off recommendation
      const WIND_SPEED_THRESHOLD = 15;

      async function fetchWeather(lat, lon) {
        if (!WEATHER_API_KEY) {
          throw new Error(
            "Weather API key not configured. Please check your .env file or GitHub secrets."
          );
        }

        const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=imperial`;
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(
            `Failed to fetch weather: ${res.status} ${res.statusText}`
          );
        }
        const data = await res.json();
        return data;
      }

      async function fetchWeatherByZip(zipCode) {
        if (!WEATHER_API_KEY) {
          throw new Error(
            "Weather API key not configured. Please check your .env file or GitHub secrets."
          );
        }

        const url = `https://api.openweathermap.org/data/2.5/forecast?zip=${zipCode}&appid=${WEATHER_API_KEY}&units=imperial`;
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(
            `Failed to fetch weather for zip ${zipCode}: ${res.status} ${res.statusText}`
          );
        }
        localStorage.setItem("weatherLocation", JSON.stringify({ zipCode }));
        const data = await res.json();
        return data;
      }

      function evaluateConditions(weather) {
        // Extract city name from the weather data
        const cityName = weather.city ? weather.city.name : "Unknown Location";

        // OpenWeatherMap forecast data - analyze today's hourly data
        const now = new Date();
        const todayStart = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate()
        );
        const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);

        // Filter forecasts for today
        const todayForecasts = weather.list.filter((forecast) => {
          const forecastTime = new Date(forecast.dt * 1000);
          return forecastTime >= todayStart && forecastTime < todayEnd;
        });

        if (todayForecasts.length === 0) {
          // If no forecasts for today, use the first few available
          todayForecasts.push(...weather.list.slice(0, 8));
        }

        let maxTemp = -Infinity;
        let maxRainChance = 0;
        let maxWind = -Infinity;

        for (const forecast of todayForecasts) {
          const temp = Math.round(forecast.main.temp);
          maxTemp = Math.max(maxTemp, temp);

          // Calculate rain chance from weather conditions
          let rainChance = 0;
          if (forecast.weather && forecast.weather[0]) {
            const weatherId = forecast.weather[0].id;
            // Rain: 500-531, Drizzle: 300-321, Thunderstorm: 200-232
            if (weatherId >= 200 && weatherId <= 531) {
              // Use probability of precipitation if available
              rainChance = forecast.pop ? forecast.pop * 100 : 50;
            }
          }
          maxRainChance = Math.max(maxRainChance, rainChance);

          // Convert m/s to mph
          const windMph = Math.round(forecast.wind.speed * 2.237);
          maxWind = Math.max(maxWind, windMph);
        }

        const topOff =
          maxTemp >= TEMP_THRESHOLD_TOP_OFF &&
          maxRainChance < RAIN_CHANCE_THRESHOLD;
        const doorsOff =
          maxTemp >= TEMP_THRESHOLD_DOORS_OFF &&
          maxRainChance < RAIN_CHANCE_THRESHOLD &&
          maxWind < WIND_SPEED_THRESHOLD;

        return {
          topOff,
          doorsOff,
          maxTemp,
          minRain: Math.round(maxRainChance),
          maxWind,
          cityName,
        };
      }

      function renderResult({
        topOff,
        doorsOff,
        maxTemp,
        minRain,
        maxWind,
        cityName,
      }) {
        // Generate image filename based on top and doors status
        const topStatus = topOff ? "off" : "on";
        const doorsStatus = doorsOff ? "off" : "on";
        const imageName = `top${topStatus}-doors${doorsStatus}.png`;
        const imagePath = `/images/${imageName}`;

        const headerHTML = `
        <h1 class="mb-4 font-bold text-2xl text-center">Today's Wrangler Weather for ${cityName}</h1>
        `;

        const imageHTML = `
        <div class="mt-6 text-center">
          <img src="${imagePath}" alt="Jeep with top ${topStatus} and doors ${doorsStatus}"
               class="shadow-md mx-auto rounded-lg max-w-full h-auto"
               style="max-height: 300px;"
               onerror="this.style.display='none'">
        </div>
        `;

        const detailsHTML = `
        <div class="mt-4">
          <p><strong>Max Temperature:</strong> ${maxTemp}°F</p>
          <p><strong>Rain Chance:</strong> ${minRain}%</p>
          <p><strong>Max Wind Speed:</strong> ${maxWind} MPH</p>
        </div>
        `;

        const statusHTML = `
        <div class="mt-6">
          <p class="font-bold text-green-600">Top: ${topOff ? "Off" : "On"}</p>
          <p class="font-bold text-green-600">Doors: ${
            doorsOff ? "Off" : "On"
          }</p>
        </div>
        `;

        const resultHTML = headerHTML + imageHTML + detailsHTML + statusHTML;

        document.getElementById("result").innerHTML = resultHTML;

        document
          .getElementById("useCurrentLocation")
          .addEventListener("click", () => {
            // Clear stored location to force fresh location request
            document.getElementById("zipcode").value = "";
            localStorage.removeItem("weatherLocation");
            getLocationAndFetchWeather();
          });
      }

      function showLocationForm() {
        document.getElementById("result").innerHTML = `
          <h1 class="mb-4 font-bold text-2xl text-center">Wrangler Weather</h1>
          <p class="mb-4 text-center text-gray-600">Please enter your location to get weather recommendations</p>
        `;
      }

      function showError(error) {
        document.getElementById(
          "result"
        ).textContent = `Error: ${error.message}`;
      }

      function getLocationAndFetchWeather() {
        // Check if location is stored in localStorage
        const storedLocation = localStorage.getItem("weatherLocation");
        if (storedLocation) {
          const { latitude, longitude, zipCode } = JSON.parse(storedLocation);
          if (zipCode) {
            fetchWeatherByZip(zipCode)
              .then((weather) => {
                const conditions = evaluateConditions(weather);
                renderResult(conditions);
              })
              .catch((e) => showError(e));
          } else if (latitude && longitude) {
            fetchWeather(latitude, longitude)
              .then((weather) => {
                const conditions = evaluateConditions(weather);
                renderResult(conditions);
              })
              .catch((e) => showError(e));
          } // else, proceed (do nothing here)
          return;
        }

        if (!navigator.geolocation) {
          showLocationForm();
          return;
        }

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            try {
              const { latitude, longitude } = position.coords;
              // Store location in localStorage
              localStorage.setItem(
                "weatherLocation",
                JSON.stringify({ latitude, longitude })
              );
              const weather = await fetchWeather(latitude, longitude);
              const conditions = evaluateConditions(weather);
              renderResult(conditions);
            } catch (e) {
              showError(e);
            }
          },
          (error) => {
            showLocationForm();
          }
        );
      }

      window.onload = getLocationAndFetchWeather;
    </script>
  </head>
  <body class="bg-gray-100 p-4 font-sans text-gray-900">
    <div class="mx-auto container">
      <div
        class="bg-white shadow-md mx-auto mt-10 p-6 rounded-xl max-w-md overflow-hidden"
      >
        <div id="result" class="text-center">Loading...</div>
      </div>
      <div
        id="location"
        class="bg-white shadow-md mx-auto mt-10 p-6 rounded-xl max-w-md overflow-hidden"
      >
        <form id="locationForm">
          <label for="zipcode" class="block font-medium text-gray-700 text-sm"
            >Change Location (Zip Code):</label
          >
          <div class="mt-1">
            <input
              type="text"
              id="zipcode"
              name="zipcode"
              class="block shadow-sm border-gray-300 focus:border-indigo-500 rounded-md w-full sm:text-sm focus:ring-indigo-500"
              placeholder="Enter Zip Code"
            />
          </div>
          <input
            type="button"
            id="useCurrentLocation"
            class="bg-gray-400 hover:bg-green-700 shadow-md mt-2 px-4 py-2 rounded-md text-white"
            value="Use Current Location"
          />

          <button
            type="submit"
            class="bg-indigo-600 mt-2 px-4 py-2 rounded-md text-white"
          >
            Submit
          </button>
        </form>
      </div>
    </div>
    <div class="mx-auto mt-5 mb-2 container">
      <footer
        class="mx-auto p-4 rounded-xl max-w-md text-center text-gray-400 text-xs"
      >
        Jeep® and Wrangler® are registered trademarks of Stellantis. This site
        is not affiliated with or endorsed by Stellantis. All trademarks are
        property of their respective owners.
      </footer>
    </div>
    <script>
      // Add event handler for locationForm submission
      document
        .getElementById("locationForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const zipCode = document.getElementById("zipcode").value;
          if (!zipCode) {
            alert("Please enter a valid zip code.");
            return;
          }
          try {
            const weather = await fetchWeatherByZip(zipCode);
            const conditions = evaluateConditions(weather);
            renderResult(conditions);
          } catch (e) {
            showError(e);
          }
        });
    </script>
  </body>
</html>
